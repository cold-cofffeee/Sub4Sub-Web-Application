<%- include('../partials/header') %>

<div class="container-fluid mt-4">
  <div class="row">
    <!-- Sidebar -->
    <div class="col-md-2 bg-dark text-white min-vh-100 py-3">
      <h5 class="mb-4"><i class="fas fa-user-shield me-2"></i>Admin Panel</h5>
      <nav class="nav flex-column">
        <a class="nav-link text-white" href="/admin/dashboard">
          <i class="fas fa-tachometer-alt me-2"></i>Dashboard
        </a>
        <a class="nav-link text-white active" href="/admin/users">
          <i class="fas fa-users me-2"></i>Users
        </a>
        <a class="nav-link text-white" href="/admin/verify-users">
          <i class="fas fa-user-check me-2"></i>Verify Users
        </a>
        <a class="nav-link text-white" href="/admin/payments">
          <i class="fas fa-dollar-sign me-2"></i>Payments
        </a>
        <a class="nav-link text-white" href="/admin/content">
          <i class="fas fa-file-alt me-2"></i>Content
        </a>
        <a class="nav-link text-white" href="/admin/settings">
          <i class="fas fa-cog me-2"></i>Settings
        </a>
        <hr class="bg-white">
        <a class="nav-link text-white" href="/">
          <i class="fas fa-home me-2"></i>Back to Site
        </a>
        <a class="nav-link text-white" href="/auth/logout">
          <i class="fas fa-sign-out-alt me-2"></i>Logout
        </a>
      </nav>
    </div>

    <!-- Main Content -->
    <div class="col-md-10">
      <h2 class="mb-4">User Management</h2>

      <!-- Search and Filter -->
      <div class="card mb-4">
        <div class="card-body">
          <form class="row g-3" method="GET">
            <div class="col-md-4">
              <input type="text" class="form-control" name="search" placeholder="Search users..." value="<%= search || '' %>">
            </div>
            <div class="col-md-3">
              <select class="form-select" name="filter">
                <option value="">All Users</option>
                <option value="premium" <%= filter === 'premium' ? 'selected' : '' %>>Premium</option>
                <option value="free" <%= filter === 'free' ? 'selected' : '' %>>Free</option>
                <option value="banned" <%= filter === 'banned' ? 'selected' : '' %>>Banned</option>
                <option value="admin" <%= filter === 'admin' ? 'selected' : '' %>>Admins</option>
              </select>
            </div>
            <div class="col-md-2">
              <button type="submit" class="btn btn-primary w-100">
                <i class="fas fa-search me-1"></i>Search
              </button>
            </div>
            <div class="col-md-3 text-end">
              <span class="badge bg-info fs-6">Total: <%= totalUsers %></span>
            </div>
          </form>
        </div>
      </div>

      <!-- Users Table -->
      <div class="card">
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>Username</th>
                  <th>Email</th>
                  <th>Points</th>
                  <th>Status</th>
                  <th>Joined</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <% if (users && users.length > 0) { %>
                  <% users.forEach(user => { %>
                    <tr>
                      <td>
                        <strong><%= user.username %></strong>
                        <% if (user.isAdmin) { %>
                          <span class="badge bg-danger ms-1">Admin</span>
                        <% } %>
                      </td>
                      <td><%= user.email %></td>
                      <td><%= user.points %></td>
                      <td>
                        <% if (user.isBanned) { %>
                          <span class="badge bg-danger">Banned</span>
                        <% } else if (user.isPremium) { %>
                          <span class="badge bg-success">Premium</span>
                        <% } else { %>
                          <span class="badge bg-secondary">Free</span>
                        <% } %>
                      </td>
                      <td><%= new Date(user.createdAt).toLocaleDateString() %></td>
                      <td>
                        <div class="btn-group" role="group">
                          <% if (!user.isAdmin) { %>
                            <form action="/admin/users/<%= user._id %>/toggle-ban" method="POST" class="d-inline">
                              <button type="submit" class="btn btn-sm <%= user.isBanned ? 'btn-success' : 'btn-warning' %>" title="<%= user.isBanned ? 'Unban' : 'Ban' %>">
                                <i class="fas fa-<%= user.isBanned ? 'check' : 'ban' %>"></i>
                              </button>
                            </form>
                            <form action="/admin/users/<%= user._id %>/toggle-premium" method="POST" class="d-inline">
                              <button type="submit" class="btn btn-sm <%= user.isPremium ? 'btn-secondary' : 'btn-info' %>" title="<%= user.isPremium ? 'Remove Premium' : 'Grant Premium' %>">
                                <i class="fas fa-<%= user.isPremium ? 'times' : 'crown' %>"></i>
                              </button>
                            </form>
                            <form action="/admin/users/<%= user._id %>/delete" method="POST" class="d-inline" onsubmit="return confirm('Are you sure you want to delete this user?')">
                              <button type="submit" class="btn btn-sm btn-danger" title="Delete">
                                <i class="fas fa-trash"></i>
                              </button>
                            </form>
                          <% } else { %>
                            <span class="text-muted">Protected</span>
                          <% } %>
                        </div>
                      </td>
                    </tr>
                  <% }) %>
                <% } else { %>
                  <tr>
                    <td colspan="6" class="text-center text-muted py-4">No users found</td>
                  </tr>
                <% } %>
              </tbody>
            </table>
          </div>

          <!-- Pagination -->
          <% if (totalPages > 1) { %>
            <nav>
              <ul class="pagination justify-content-center">
                <li class="page-item <%= currentPage === 1 ? 'disabled' : '' %>">
                  <a class="page-link" href="?page=<%= currentPage - 1 %>&search=<%= search || '' %>&filter=<%= filter || '' %>">Previous</a>
                </li>
                <% for (let i = 1; i <= totalPages; i++) { %>
                  <li class="page-item <%= currentPage === i ? 'active' : '' %>">
                    <a class="page-link" href="?page=<%= i %>&search=<%= search || '' %>&filter=<%= filter || '' %>"><%= i %></a>
                  </li>
                <% } %>
                <li class="page-item <%= currentPage === totalPages ? 'disabled' : '' %>">
                  <a class="page-link" href="?page=<%= currentPage + 1 %>&search=<%= search || '' %>&filter=<%= filter || '' %>">Next</a>
                </li>
              </ul>
            </nav>
          <% } %>
        </div>
      </div>
    </div>
  </div>
</div>

<%- include('../partials/footer') %>
